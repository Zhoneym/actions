name: Build switch-l4t kernels (linux-5.1.2)

on:
  push:
    branches:
      - linux-5.1.2
  workflow_dispatch:

jobs:
  build-kernels:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        name: [switch-l4t-kernel-nvidia, switch-l4t-kernel-4.9, switch-l4t-platform-t210-nx]
        repo: [CTCaer/switch-l4t-kernel-nvidia, CTCaer/switch-l4t-kernel-4.9, CTCaer/switch-l4t-platform-t210-nx]
    steps:
      - name: Checkout repo ${{ matrix.name }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          ref: linux-5.1.2

      - name: Print working directory
        run: pwd

      - name: Prepare build
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          make tegra_linux_defconfig

      - name: Build kernel
        run: make -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.name }}-kernel-image
          path: |
            arch/arm64/boot/Image
            vmlinux

