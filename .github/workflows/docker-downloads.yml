name: Build Podman Static v5.5.2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git make golang gcc \
            btrfs-progs libbtrfs-dev \
            libdevmapper-dev \
            libglib2.0-dev \
            libgpgme-dev \
            libassuan-dev \
            libseccomp-dev \
            pkg-config \
            libsystemd-dev \
            wget bzip2

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Download Podman v5.5.2 source
        run: |
          wget https://github.com/containers/podman/archive/refs/tags/v5.5.2.tar.gz
          tar -xf v5.5.2.tar.gz
          mv podman-5.5.2 podman
          cd podman
          echo "GOFLAGS=-buildvcs=false" >> .gopackages.toml  # 避免 git 依赖问题

      - name: Build static binary
        run: |
          cd podman
          make podman-static

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: podman-static-v5.5.2
          path: podman/bin/podman-static
