name: Build HopSignal Docker Image (systemd)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Dockerfile
        run: |
          cat <<'EOF' > Dockerfile
          FROM ubuntu:24.04

          ENV DEBIAN_FRONTEND=noninteractive

          # 安装 systemd 和工具
          RUN apt-get update -y && \
              apt-get install -y systemd wget curl bash cron && \
              apt-get clean && \
              rm -rf /var/lib/apt/lists/*

          WORKDIR /home

          # 下载并执行 HopSignal 官方安装脚本
          RUN curl -o hsinstall.sh -sL https://www.hoptodesk.com/hs/hsinstall && \
              chmod +x hsinstall.sh && \
              bash hsinstall.sh

          # 暴露 HopSignal 默认端口
          EXPOSE 80 82

          # 以 systemd 作为 PID 1 启动
          CMD ["/sbin/init"]
          EOF

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t hopsignal:systemd .

      - name: Save Docker image to tar
        run: |
          mkdir -p output
          docker save hopsignal:systemd -o output/hopsignal-systemd.tar
          ls -lh output/

      - name: Upload hopsignal tar
        uses: actions/upload-artifact@v4
        with:
          name: hopsignal-image
          path: output/hopsignal-systemd.tar
          retention-days: 7

