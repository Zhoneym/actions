name: Build Python 3.9 musl static with xlwings (ARM64)

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install musl-cross toolchain (ARM64)
      run: |
        sudo apt update
        sudo apt install -y musl-tools wget xz-utils build-essential

        # 下载 musl-cross aarch64 工具链
        wget https://musl.cc/aarch64-linux-musl-cross.tgz
        tar xf aarch64-linux-musl-cross.tgz
        echo "$PWD/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH

    - name: Download Python source
      run: |
        wget https://www.python.org/ftp/python/3.9.19/Python-3.9.19.tgz
        tar xf Python-3.9.19.tgz

    - name: Configure & Cross-Compile Python (static musl)
      run: |
        cd Python-3.9.19

        export CC=aarch64-linux-musl-gcc
        export CXX=aarch64-linux-musl-g++
        export AR=aarch64-linux-musl-ar
        export RANLIB=aarch64-linux-musl-ranlib
        export LD=aarch64-linux-musl-ld

        ./configure \
          --prefix=$PWD/../python39 \
          --build=x86_64-linux-gnu \
          --host=aarch64-linux-musl \
          --enable-optimizations \
          --with-lto \
          --with-static-libpython \
          LDFLAGS="-static"

        make -j$(nproc)
        make install

    - name: Install Python packages (xlwings / pyinstaller)
      run: |
        # 安装 pip, 不运行 ARM 代码（使用跨平台方式）
        python39/bin/python3 -m ensurepip

        # 强制 manylinux ARM64 取 wheel，不执行 import，不执行构建
        python39/bin/pip3 install \
          --platform manylinux2014_aarch64 \
          --only-binary=:all: \
          --target python39/lib/python3.9/site-packages \
          xlwings pyinstaller

    - name: Package environment
      run: |
        tar -czf python39_musl_static.tar.gz python39

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: python39-musl-static
        path: python39_musl_static.tar.gz
