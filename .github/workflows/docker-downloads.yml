name: Build HopSignal Docker Image

on:
  workflow_dispatch:       # 允许手动触发
  push:
    branches:
      - main               # 也可改成你的分支

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 拉取仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 在工作流中动态写入 Dockerfile
      - name: Create Dockerfile
        run: |
          cat <<'EOF' > Dockerfile
          FROM ubuntu:22.04

          ENV DEBIAN_FRONTEND=noninteractive

          # 安装 systemd、wget、curl、cron
          RUN apt-get update -y && \
              apt-get install -y systemd wget curl cron && \
              apt-get clean && \
              rm -rf /var/lib/apt/lists/*

          WORKDIR /root

          # 下载原始 hsinstall.sh
          RUN curl -o hsinstall.sh -sL https://www.hoptodesk.com/hs/hsinstall && \
              chmod +x hsinstall.sh

          # 容器启动时执行安装脚本并交给 systemd
          CMD ["/bin/bash","-c","/root/hsinstall.sh && exec /sbin/init"]
          EOF

      # 设置 Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 构建镜像
      - name: Build Docker image
        run: |
          docker build -t hopsignal:latest .

      # 保存为 tar 文件
      - name: Save Docker image to tar
        run: |
          mkdir -p output
          docker save hopsignal:latest -o output/hopsignal.tar
          ls -lh output/

      # 上传 tar 工件
      - name: Upload hopsignal tar
        uses: actions/upload-artifact@v4
        with:
          name: hopsignal-image
          path: output/hopsignal.tar
          retention-days: 7
