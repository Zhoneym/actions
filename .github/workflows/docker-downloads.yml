name: Build sane-airscan arm64 deb

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build inside arm64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu24.04
          run: |
            apt-get update
            apt-get install -y build-essential meson ninja-build pkg-config \
              libjpeg-dev libpng-dev libtiff-dev libgnutls28-dev \
              libavahi-client-dev libavahi-common-dev libxml2-dev zlib1g-dev \
              libsane-dev dh-make devscripts fakeroot git

            git clone https://github.com/alexpevzner/sane-airscan.git
            cd sane-airscan
            mkdir build && cd build
            meson setup --prefix=/usr --buildtype=release ..
            ninja

            cd ..
            # 打一个最简单的二进制包（不写复杂 debian/）
            checkinstall --install=no --pkgname=sane-airscan --pkgversion=1.0 --arch=arm64 -y

            mkdir -p /github/workspace/artifacts
            mv *.deb /github/workspace/artifacts/

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: sane-airscan-arm64
          path: artifacts/*.deb
