name: Build OpenSSH (musl)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build OpenSSH with musl

    steps:
      # -------------------------------
      # 1️⃣ 检出仓库（可选）
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2️⃣ 下载 musl 工具链
      # -------------------------------
      - name: Download musl toolchain
        run: |
          wget -q https://musl.cc/x86_64-linux-musl-native.tgz
          tar -xf x86_64-linux-musl-native.tgz
          echo "$PWD/x86_64-linux-musl-native/bin" >> $GITHUB_PATH

      # -------------------------------
      # 3️⃣ 下载 OpenSSH 源码
      # -------------------------------
      - name: Download OpenSSH source
        run: |
          wget -q https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-10.2p1.tar.gz
          tar -xf openssh-10.2p1.tar.gz

      # -------------------------------
      # 4️⃣ 编译 OpenSSH
      # -------------------------------
      - name: Configure & Build
        working-directory: openssh-10.2p1
        run: |
          export CC=x86_64-linux-musl-gcc
          export CXX=x86_64-linux-musl-g++
          export AR=x86_64-linux-musl-ar
          export RANLIB=x86_64-linux-musl-ranlib
          export LD=x86_64-linux-musl-ld
          export CFLAGS="-Os -static"
          export LDFLAGS="-static"

          ./configure \
            --prefix=/openssh \
            --with-privsep-path=/var/empty \
            --without-openssl-engine \
            --without-zlib-version-check

          make -j$(nproc)

      # -------------------------------
      # 5️⃣ 打包编译结果
      # -------------------------------
      - name: Package build results
        run: |
          tar -czf openssh-10.2p1-musl-build.tar.gz openssh-10.2p1

      # -------------------------------
      # 6️⃣ 上传 Artifact
      # -------------------------------
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssh-10.2p1-musl-build
          path: openssh-10.2p1-musl-build.tar.gz
