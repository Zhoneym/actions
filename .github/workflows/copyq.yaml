name: Build Python 3.9 with xlwings (musl static)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Docker with arm64 architecture
      run: |
        sudo docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Build musl-static Python 3.9 with xlwings
      run: |
        docker run --rm --platform linux/arm64 -v $PWD:/workspace -w /workspace arm64v8/ubuntu:20.04 bash -c "
          apt update && apt install -y build-essential curl gcc g++ make \
          python3.9 python3.9-dev python3.9-venv libssl-dev libffi-dev \
          zlib1g-dev libreadline-dev libbz2-dev musl-dev \
          && curl -O https://bootstrap.pypa.io/get-pip.py && python3.9 get-pip.py \
          && python3.9 -m pip install --upgrade pip \
          && python3.9 -m venv /workspace/venv \
          && /workspace/venv/bin/pip install xlwings \
          && /workspace/venv/bin/pip install pyinstaller"

    - name: Package environment
      run: |
        # Create a tarball of the virtual environment for offline use
        tar -czf python_env.tar.gz -C /workspace venv

    - name: Upload the package
      uses: actions/upload-artifact@v4
      with:
        name: python-env
        path: python_env.tar.gz
