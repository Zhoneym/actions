name: Build Python 3.9 ARM64 with xlwings

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup QEMU
      run: |
        sudo apt update
        sudo apt install -y qemu qemu-user-static

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make wget curl

    - name: Download musl source
      run: |
        wget https://musl.libc.org/releases/musl-1.2.2.tar.gz
        tar -xvzf musl-1.2.2.tar.gz
        cd musl-1.2.2
        ./configure --prefix=/opt/musl
        make
        sudo make install

    - name: Build Python 3.9 with MUSL
      run: |
        wget https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tgz
        tar -xvzf Python-3.9.0.tgz
        cd Python-3.9.0
        ./configure --prefix=/opt/python --host=aarch64-linux-musl --with-musl
        make
        sudo make install

    - name: Install xlwings
      run: |
        /opt/python/bin/python3.9 -m venv /opt/python-env
        source /opt/python-env/bin/activate
        pip install xlwings

    - name: Package Python environment
      run: |
        tar -czf python-env.tar.gz -C /opt python-env
        tar -czf python-with-modules.tar.gz -C /opt python
