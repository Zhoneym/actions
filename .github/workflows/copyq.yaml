name: Build Python 3.9 with xlwings

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up musl cross-compiling environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          wget \
          gcc \
          musl-tools \
          libssl-dev \
          zlib1g-dev \
          libbz2-dev \
          libreadline-dev \
          libsqlite3-dev \
          tk-dev \
          libgdbm-dev \
          liblzma-dev \
          libyaml-dev \
          libffi-dev \
          libsqlite3-dev \
          libssl-dev \
          git \
          clang \
          llvm

    - name: Download Python 3.9 source
      run: |
        wget https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tgz
        tar -xzf Python-3.9.0.tgz
        cd Python-3.9.0
        
        # 使用 musl 进行交叉编译
        ./configure \
          --prefix=/opt/python \
          --host=aarch64-linux-musl \
          --build=x86_64-linux-gnu \
          --with-ensurepip=install \
          --enable-optimizations \
          --with-system-ffi \
          --without-ensurepip

        # 编译 Python
        make -j$(nproc)
        sudo make altinstall

    - name: Install xlwings
      run: |
        /opt/python/bin/pip3.9 install xlwings

    - name: Package environment for offline use
      run: |
        cd /opt/python
        tar czf /tmp/python_3.9_arm64_with_xlwings.tar.gz .
      
    - name: Upload tarball artifact
      uses: actions/upload-artifact@v3
      with:
        name: python_3.9_arm64_with_xlwings
        path: /tmp/python_3.9_arm64_with_xlwings.tar.gz
